# 仿B站项目

## 亮点一：设计模式的使用

### 背景（技术问题）：

当时在做这个登录的功能，这个登录同时支持这个邮箱和手机号码登录，大致的流程就是前端会传过来两个字段，一个字段是email或者phone，另一个是对应的值，后端接收到这两个参数的时候，会判断传的是哪一个字段，首先对这个用户有没有注册进行判断校验，校验成功后会这个进行密码验证，验证成功了就会这个返回一个token。在这个背景中我就发现有一个问题，就是这个代码的拓展性不是很好，并且要写过多的代码，因为你要写很多的if语句去判断各种情况，看一下前端到底传的是哪个值，比如传输的是手机号还是这个emial，确认了之后，还需要些不同的sql去查用户，比如说这个知道了手机号，我就要通过这个手机号，看一下这个用户是否存在，传的是email就要去根据email写一个sql看一下是否存在。

在没有了解过策略模式之前，我其实自己已经进行了一点优化，我这个去除了所有的if-else，我把这个所有的参数，比如说手机和邮箱都传入到了一条的mybatis的sql里面，在这个mybatis的xml中，我用了一个动态的sql，会去判断传进来的参数是否为空，只有这个不为空，才会调用这个where语句，这样相当于减少了这个sql语句的编写，也省去了很多的if-else判断。

### 过程（解决问题的过程）：

后来我学习了设计模式，了解到了，这个策略和工厂模式以及这个开闭原则，发现了我的原来的代码还可以进行改进，因为我原来的代码，比如说增加了一个微信登录的代码，还是要去修改这个主业务代码，不能去做到真正的解耦，但是用了这个策略家工厂的话，我们可以定义一个抽象工厂，和两个具体的工厂，按照不同策略，可以实现为手机号登录和这个邮箱登录，我们不用去关心内部实习，只要获取不同的工厂就行了，后续如果增加，也只需要增加不同的策略，不需要改动原来的代码。

### 最终落地方案

首先设计了一个抽象策略类，和两个具体的策略类，在抽象策略类这个interface中定义了一个login方法，两个具体的策略类，分别是这个手机登录策略类和这个email登录策略类，分别实现了这个login方法。其次我定义了一个工厂类，这个工厂类继承了ApplicationContextAware，并且重写了里面的一个setApplicationContext类，这个方法会在初始化工厂的时候，根据我在这个application.propertities配之类中去读取数据，然后读取到一个map中去，并且这个工厂中提供来一个生产具体策略的方法，里面传入的值是登录的类型，因此在这个业务代码中，我只需要去初始化这个工厂类，然后在这个工厂类中去获取一个工厂，然后把前端传过来的登录的类型传给工厂的获取具体策略的方法，最后再调用这个策略工厂的登录方法就可以了，过程中完全不需要进行修改原来的代码



## 亮点二：线程池的使用

### 背景：

当时我在做这个视频详情页的功能，这里面前端需要获取点赞、投币和收藏的数量以及本人是否点赞投币过的这种接口，当时我自己是写了三个接口，然后前端需要去调用三次，每次的调用时间，都在130ms左右，由于是这种串行调用的，加起来差不掉就是400ms了，因此还是比较影响这个详情也整体的加载速度的，因为这个详情页的体验是最难做好的，是一个比较重的页面，元素比较多，包括这个弹幕和视频，肯定是能优化一点，就能提升比较大的用户体验的。因此当时就想到了用线程池

### 过程:

期间我利用这个线程池用多线程来进行了这个的加速，因为我认为我这个三个接口中，是没有前后依赖的一个关系的，类似于一个报表的功能，因此可以用这个线程池的技术来进行优化。

### 最终落地：

具体来说，我首先创建了一个线程池的配之类，在配置类中，定义了一个线池成员变量，并且用的也是这个ThreadPoolExecutor，并且规定了一下线程池的参数，其中考虑到我这个三个接口其实都没有什么cpu的消耗，主要是进行一些教研去查数据库，主要是有IO的操作，因此我判定这个本质还是属于一个IO密集型，因此我设置了这个核心线程数为这个推荐的2N + 1，由于我这个是租的腾讯云的2c2g的这个服务器，因此也就是5，并且我考虑到了，这个用户不会频繁去刷新，因此这个最大线程数就只设置了6，并且设置了1分钟的存活时间，也选用了这个LinkedBlockingQueue，并且设置了1000的大小。并且，我把这个初始化的动作，放到了一个静态代码快中，类加载之后就可以直接初始化线程池，之后拿来就用。之后我重新写了一个接口，在这个接口的方法中，我把这个获取点赞投币收藏的三个操作，每次都提交这个线程池中去执行，并且由于我是要返回数据的，我这里选择了重写这个Callable接口并且搭配这个Future获取到了数据，最后整合到map中进行了返回，最终经过测试，接口响应时间从150ms优化到了50ms，接口的速度提升了67%。

